<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Tablet Config Checker (CDN, IAL+UI+Logs)</title>

<!-- â‘  ç›´æ¥è°ƒç”¨ xlsx.full.min.jsï¼ˆCDNï¼‰ -->
<script>
(function loadXLSX(){
  const cdn1 = "https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js";
  const cdn2 = "https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js";
  function inject(src, onok, onerr){
    const s = document.createElement('script');
    s.src = src; s.async = true;
    s.onload = onok; s.onerror = onerr;
    document.head.appendChild(s);
  }
  inject(cdn1, ()=>{ window.__XLSX_READY__ = true; console.log("XLSX loaded via cdnjs"); },
               ()=>inject(cdn2, ()=>{ window.__XLSX_READY__ = true; console.log("XLSX loaded via unpkg"); },
                                   ()=>{ window.__XLSX_READY__ = false; console.error("Failed to load XLSX from both CDNs"); }));
})();
</script>

<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Microsoft YaHei','SF Pro',sans-serif;background:#f7f7f5;min-height:100vh;color:#2f3437}
.container{max-width:1400px;margin:0 auto;padding:0 40px}
.header{color:#2c3e50;padding:80px 60px 20px;text-align:center}
.header h1{font-size:48px;font-weight:700;letter-spacing:-1.5px;margin-bottom:8px;background:linear-gradient(135deg,#2c3e50,#34495e);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
.header p{font-size:15px;color:#7f8c8d}
.upload-section{display:grid;grid-template-columns:1fr 1fr 1fr;gap:24px;margin-bottom:28px}
.upload-box{border:2px dashed rgba(44,62,80,.15);border-radius:18px;padding:28px;text-align:center;background:rgba(255,255,255,.7);backdrop-filter:blur(10px);min-height:240px}
.upload-box h3{color:#2c3e50;margin-bottom:8px;font-size:18px;font-weight:600}
.upload-box p{color:#7f8c8d;font-size:13px;margin-bottom:12px}
.file-input-wrapper{position:relative;display:inline-block;width:100%;margin:12px 0}
.upload-box input[type=file]{position:absolute;left:-9999px;opacity:0}
.file-input-label{display:inline-block;padding:10px 22px;background:#2c3e50;color:#fff;border-radius:10px;font-size:14px;font-weight:500;cursor:pointer;box-shadow:0 3px 10px rgba(44,62,80,.2)}
.file-info{margin-top:12px;padding:12px 14px;background:rgba(236,240,241,.6);border-radius:12px;font-size:12px;color:#7f8c8d;text-align:left;border:1px solid rgba(0,0,0,.04)}
.controls-row{max-width:980px;margin:0 auto 12px;display:flex;gap:8px;justify-content:flex-end}
.controls-row button{background:#334155;color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer}
.controls-row button:disabled{opacity:.5;cursor:not-allowed}
.check-button{background:linear-gradient(135deg,#2c3e50,#34495e);color:#fff;border:none;padding:14px 40px;border-radius:12px;font-size:15px;font-weight:500;cursor:pointer;display:block;margin:0 auto 6px;box-shadow:0 8px 24px rgba(44,62,80,.25)}
#status{text-align:center;font-size:12px;color:#7f8c8d;margin:6px auto 10px}
.results{margin-top:24px}
.results h3{text-align:center;color:#2c3e50;margin-bottom:18px;font-size:22px;font-weight:700}
.check-item{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;margin:8px 0;background:#fff;border-radius:14px;border:1px solid #eee}
.check-item .item-name{font-weight:600;color:#2c3e50;font-size:14px;flex:1}
.check-item .item-values{font-size:12px;color:#586069;margin:0 18px;text-align:center;flex:2}
.status{padding:6px 14px;border-radius:10px;font-weight:600;font-size:12px}
.status.pass{background:rgba(39,174,96,.1);color:#27ae60;border:1px solid rgba(39,174,96,.2)}
.status.fail{background:rgba(231,76,60,.1);color:#e74c3c;border:1px solid rgba(231,76,60,.2)}
.summary{margin-top:22px;padding:22px;background:#fff;border-radius:14px;text-align:center;border:1px solid #eee}
/* é¡¶éƒ¨ 100% æ­£ç¡®ç‡æ¨ªå¹… */
.top-banner{max-width:980px;margin:0 auto 18px;padding:14px 16px;border-radius:12px;border:2px solid #22c55e;background:linear-gradient(135deg,rgba(34,197,94,.10),rgba(34,197,94,.18));color:#14532d;box-shadow:0 2px 6px rgba(34,197,94,.15);font-weight:600;text-align:center}
/* PN å¡ç‰‡ï¼ˆdetails/summary æŠ˜å ï¼‰ */
.pn-card{margin-bottom:16px;border:1px solid #eee;border-radius:16px;background:#fff;overflow:hidden}
.pn-card summary{list-style:none;cursor:pointer;user-select:none;background:linear-gradient(135deg,#2c3e50,#34495e);color:#fff;padding:14px 18px;font-weight:600;font-size:1rem;display:flex;align-items:center;justify-content:space-between}
.pn-heading{display:flex;gap:10px;align-items:baseline}
.pn-heading .pn-id{font-size:1.1rem}
.pn-heading .pn-full{opacity:.85;font-size:.85rem}
.badge{display:inline-block;padding:6px 10px;border-radius:14px;font-weight:700;font-size:.85rem;letter-spacing:.2px;background:rgba(255,255,255,.15)}
.badge-pass{color:#d1fae5}
.badge-fail{color:#fee2e2}
.pn-body{padding:12px 14px}
details.logfold{max-width:1400px;margin:20px auto 40px}
details.logfold>summary{list-style:none;cursor:pointer;background:#fff;border:1px solid #eee;border-radius:10px;padding:10px 14px;display:flex;align-items:center;justify-content:space-between;font-weight:600;color:#2c3e50}
details.logfold>summary::after{content:"å±•å¼€æ—¥å¿—"}
details.logfold[open]>summary::after{content:"æ”¶èµ·æ—¥å¿—"}
#logPanel{margin-top:10px;background:#fff;border:1px solid #eee;border-radius:10px;padding:10px}
#log{font-family:ui-monospace,Menlo,Consolas,monospace;background:#0f172a;color:#e2e8f0;padding:10px;border-radius:8px;white-space:pre-wrap;line-height:1.7;font-size:12px;max-height:250px;overflow:auto}
.log-actions{display:flex;gap:8px;margin-bottom:8px}
.log-actions button{background:#334155;color:#fff;border:none;padding:6px 10px;border-radius:8px;cursor:pointer}
@media(max-width:1024px){.upload-section{grid-template-columns:1fr 1fr}}
@media(max-width:768px){.container{padding:0 20px}.header{padding:40px 20px 18px}.upload-section{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>Tablet Config Checker</h1>
    <p>å·²é€šè¿‡ CDN ç›´æ¥è°ƒç”¨ <code>xlsx.full.min.js</code>ï¼Œæ— éœ€æœ¬åœ°æ–‡ä»¶ã€‚</p>
  </div>

  <div id="config" style="padding:0 0 20px;">
    <div class="upload-section">
      <div class="upload-box">
        <h3>Element.xlsx</h3>
        <p>åŒ…å« â€œTYPE NAME / ELEMENT NAME / ä»ç¬¬4åˆ—èµ·çš„ PN åˆ—ï¼ˆZA å¼€å¤´ 10 ä½ï¼‰â€ã€‚</p>
        <div class="file-input-wrapper">
          <input type="file" id="elementFile" accept=".xlsx,.xls" />
          <label for="elementFile" class="file-input-label">é€‰æ‹©æ–‡ä»¶</label>
        </div>
        <div id="elementInfo" class="file-info" style="display:none;"></div>
      </div>
      <div class="upload-box">
        <h3>PORSheet.xls</h3>
        <p>åŒ…å« â€œNumber / CAMERA / CAMERA_BACK / BATTERY / CPU / COLOUR / ADAPTER / WLAN / WWAN â€¦â€ã€‚</p>
        <div class="file-input-wrapper">
          <input type="file" id="porFile" accept=".xlsx,.xls" />
          <label for="porFile" class="file-input-label">é€‰æ‹©æ–‡ä»¶</label>
        </div>
        <div id="porInfo" class="file-info" style="display:none;"></div>
      </div>
      <div class="upload-box">
        <h3>IAL.xlsxï¼ˆTechï¼‰</h3>
        <p>åªéœ€å…³æ³¨ <b>Tech</b> å·¥ä½œè¡¨ï¼šA åˆ—ä¸ºé¡¹åï¼ˆOS/Display/Dimensions/Weightï¼‰ï¼ŒB åˆ—ä¸ºç»†èŠ‚ã€‚</p>
        <div class="file-input-wrapper">
          <input type="file" id="ialFile" accept=".xlsx,.xls" />
          <label for="ialFile" class="file-input-label">é€‰æ‹©æ–‡ä»¶</label>
        </div>
        <div id="ialInfo" class="file-info" style="display:none;"></div>
      </div>
    </div>

    <div class="controls-row">
      <button id="toggleErrorBtn" disabled>åªçœ‹é”™è¯¯</button>
    </div>

    <button id="runBtn" class="check-button" disabled>å¼€å§‹é…ç½®æ£€éªŒ</button>
    <div id="status">çŠ¶æ€ï¼šè§£æåº“ åŠ è½½ä¸­â€¦ï¼›Element æœªé€‰æ‹©ï¼›POR æœªé€‰æ‹©ï¼›IAL æœªé€‰æ‹©</div>

    <div id="results" class="results" style="display:none;">
      <h3>é…ç½®æ£€éªŒç»“æœ</h3>
      <div id="checkResults"></div>
      <div id="summary" class="summary"></div>
    </div>
  </div>

  <!-- è¿è¡Œæ—¥å¿— -->
  <details class="logfold" open>
    <summary>
      <span>è¿è¡Œæ—¥å¿—</span>
      <span id="logHint" style="font-size:12px; color:#7f8c8d;">å°±ç»ª</span>
    </summary>
    <div id="logPanel">
      <div class="log-actions">
        <button id="logClearBtn">æ¸…ç©ºæ—¥å¿—</button>
        <button id="logScrollBtn">æ»šåŠ¨åˆ°åº•éƒ¨</button>
      </div>
      <div id="log">å°±ç»ªã€‚</div>
    </div>
  </details>
</div>

<script>
/* ===== æ—¥å¿—å·¥å…· ===== */
const logDiv=document.getElementById('log'), logHint=document.getElementById('logHint');
document.getElementById('logClearBtn').addEventListener('click',()=>{ logDiv.textContent='ï¼ˆå·²æ¸…ç©ºï¼‰'; logHint.textContent='æ—¥å¿—å·²æ¸…ç©º'; });
document.getElementById('logScrollBtn').addEventListener('click',()=>{ logDiv.scrollTop=logDiv.scrollHeight; });
function log(msg){ const ts=new Date().toISOString().replace('T',' ').slice(0,19); logDiv.textContent+=`\n[${ts}] ${msg}`; logHint.textContent = msg.length>40 ? (msg.slice(0,40)+'â€¦') : msg; }

/* ===== çŠ¶æ€ä¸æ–‡ä»¶è¯»å– ===== */
const elIn=document.getElementById('elementFile');
const porIn=document.getElementById('porFile');
const ialIn=document.getElementById('ialFile');
const elInfo=document.getElementById('elementInfo');
const porInfo=document.getElementById('porInfo');
const ialInfo=document.getElementById('ialInfo');
let elementWB=null, porWB=null, ialWB=null;

function refreshStatus(){
  const libOk = !!(window.__XLSX_READY__ && window.XLSX && XLSX.read);
  const eOk=!!elementWB, pOk=!!porWB, iOk=!!ialWB;
  document.getElementById('status').textContent =
    `çŠ¶æ€ï¼šè§£æåº“ ${libOk?'å·²åŠ è½½':'åŠ è½½ä¸­/å¤±è´¥'}ï¼›Element ${eOk?'å·²é€‰æ‹©':'æœªé€‰æ‹©'}ï¼›POR ${pOk?'å·²é€‰æ‹©':'æœªé€‰æ‹©'}ï¼›IAL ${iOk?'å·²é€‰æ‹©':'æœªé€‰æ‹©'}`;
  document.getElementById('runBtn').disabled = !(libOk && eOk && pOk && iOk);
  document.getElementById('toggleErrorBtn').disabled = !(libOk && eOk && pOk && iOk);
}
setInterval(refreshStatus, 800); // ç®€å•è½®è¯¢åº“åŠ è½½å®Œæˆ

async function readWorkbookSafe(file, tag){
  try{
    if(!file) return null;
    if(!(window.__XLSX_READY__ && window.XLSX && XLSX.read)){
      log(`[${tag}] æš‚ä¸è§£æï¼šè§£æåº“æœªå°±ç»ª`); return null;
    }
    const buf = await file.arrayBuffer();
    const wb = XLSX.read(buf,{type:'array',WTF:false});
    log(`[${tag}] è§£ææˆåŠŸï¼šå·¥ä½œè¡¨=${wb.SheetNames.join(', ')}`);
    return wb;
  }catch(err){
    alert(tag+' æ–‡ä»¶è¯»å–å¤±è´¥ï¼š'+err.message);
    log(`[${tag}] æ–‡ä»¶è¯»å–å¤±è´¥ï¼š${err.message}`);
    return null;
  }
}

elIn.addEventListener('change', async (e)=>{
  const f=e.target.files[0];
  if(!f){ elInfo.style.display='none'; elementWB=null; refreshStatus(); return; }
  log(`é€‰æ‹©äº† Element æ–‡ä»¶ï¼š${f.name}`);
  elInfo.style.display='block';
  elInfo.innerHTML=`<strong>æ–‡ä»¶å:</strong> ${f.name}`;
  elementWB=await readWorkbookSafe(f,'Element'); refreshStatus();
});

porIn.addEventListener('change', async (e)=>{
  const f=e.target.files[0];
  if(!f){ porInfo.style.display='none'; porWB=null; refreshStatus(); return; }
  log(`é€‰æ‹©äº† POR æ–‡ä»¶ï¼š${f.name}`);
  porInfo.style.display='block';
  porInfo.innerHTML=`<strong>æ–‡ä»¶å:</strong> ${f.name}`;
  porWB=await readWorkbookSafe(f,'POR'); refreshStatus();
});

ialIn.addEventListener('change', async (e)=>{
  const f=e.target.files[0];
  if(!f){ ialInfo.style.display='none'; ialWB=null; refreshStatus(); return; }
  log(`é€‰æ‹©äº† IAL æ–‡ä»¶ï¼š${f.name}`);
  ialInfo.style.display='block';
  ialInfo.innerHTML=`<strong>æ–‡ä»¶å:</strong> ${f.name}`;
  ialWB=await readWorkbookSafe(f,'IAL'); refreshStatus();
});

/* ===== å·¥å…·å‡½æ•° ===== */
function escapeReg(s){ return String(s).replace(/[.*+?^${}()|[\]\\]/g,'\\$&'); }
function escapeHTML(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function normalizeHeader(s){ return String(s||'').replace(/\u00A0/g,' ').replace(/[\u200B-\u200D]/g,'').replace(/\s+/g,' ').trim().toUpperCase(); }
function parseCamMPInt(s){ s=String(s||''); let m=s.match(/(\d+(?:\.\d+)?)\s*MP/i)||s.match(/(\d+)\s*MP/i); if(m){const v=Number(m[1]); if(!Number.isNaN(v)) return Math.round(v);} return null; }
function parseCamMode(s){ const up=String(s||'').toUpperCase(); if(up.includes('AF')||up.includes('AUTO FOCUS')) return 'AF'; if(up.includes('FF')||up.includes('FIXED FOCUS')) return 'FF'; return null; }
function intsInText(s){ return (String(s||'').match(/\d+/g)||[]); }
function normalizeWWANValue(s){ const up=String(s||'').trim().toUpperCase(); if(up===''||up==='NONE'||up==='NO WWAN'||up==='NO') return 'NONE'; return 'SOME'; }
function isMarked(val){ const s=String(val||'').trim().toUpperCase(); return s==='X' || /^A(?:\.\d+)?$/.test(s) || /^U(?:\.\d+)?$/.test(s); }

/* ===== ç»•è¿‡ ws['!ref']ï¼šçœŸå®èŒƒå›´ ===== */
function computeRealRangeFromKeys(ws) {
  const isCell = (k) => /^[A-Za-z]+[0-9]+$/.test(k);
  let minR = Infinity, minC = Infinity, maxR = -Infinity, maxC = -Infinity;
  for (const k of Object.keys(ws)) {
    if (!isCell(k)) continue;
    const cell = XLSX.utils.decode_cell(k);
    if (cell.r < minR) minR = cell.r;
    if (cell.c < minC) minC = cell.c;
    if (cell.r > maxR) maxR = cell.r;
    if (cell.c > maxC) maxC = cell.c;
  }
  if (minR === Infinity) { return XLSX.utils.decode_range(ws['!ref'] || 'A1:A1'); }
  return { s: { r: minR, c: minC }, e: { r: maxR, c: maxC } };
}

/* ===== è§£æ Elementï¼ˆåœ°å€é”®æ‰«æ + ZA10 + æ‰©å¤§è¡¨å¤´æ‰«æçª—ï¼‰ ===== */
function parseElementSheet(wb){
  const sheetName = wb.SheetNames[0];
  const ws = wb.Sheets[sheetName];

  const aoa = XLSX.utils.sheet_to_json(ws,{header:1,blankrows:false,defval:''});
  if(!aoa.length) throw new Error('Element.xlsx å†…å®¹ä¸ºç©ºã€‚');

  let headerIdx=-1;
  for(let i=0;i<aoa.length;i++){
    const row=aoa[i]||[];
    if(row.some(cell => normalizeHeader(cell)==='TYPE NAME')) { headerIdx=i; break; }
  }
  if(headerIdx<0) throw new Error('åœ¨ Element.xlsx ä¸­æœªæ‰¾åˆ° "TYPE NAME" è¡Œã€‚');

  const headerRow = aoa[headerIdx] || [];
  let idxType = headerRow.findIndex(h=>normalizeHeader(h)==='TYPE NAME');
  let idxName = headerRow.findIndex(h=>normalizeHeader(h)==='ELEMENT NAME');
  if(idxType<0) idxType=1;
  if(idxName<0) idxName=2;

  const realRange = computeRealRangeFromKeys(ws);
  const refRange  = XLSX.utils.decode_range(ws['!ref'] || 'A1:A1');
  log(`Excel èŒƒå›´(æŠ¥å‘Šçš„ !ref): ${XLSX.utils.encode_range(refRange)}ï¼›çœŸå®èŒƒå›´(åœ°å€é”®): ${XLSX.utils.encode_range(realRange)}ï¼›headerIdx=${headerIdx}ï¼›idxType=${idxType}ï¼›idxName=${idxName}`);

  const pnCols=[];
  const ZA10 = /(?:\[|ï¼»|ã€)?(ZA[A-Za-z0-9]{8})(?:\]|ï¼½|ã€‘)?/;

  function findPNInTopRows(c){
    const upperLimit = Math.min(realRange.e.r, headerIdx + 20);
    for (let r = 0; r <= upperLimit; r++) {
      const addr = XLSX.utils.encode_cell({r, c});
      const cell = ws[addr];
      const h = cell ? String(cell.v||'').trim() : '';
      const m = h.match(ZA10);
      if (m) return { fullHeader: h, pn: m[1] };
    }
    return null;
  }

  for(let c=3; c<=realRange.e.c; c++){
    let markCount=0;
    for(let r=headerIdx+1; r<=realRange.e.r; r++){
      const v = (ws[XLSX.utils.encode_cell({r,c})]||{}).v;
      if(isMarked(v)) markCount++;
    }
    const hit = findPNInTopRows(c);
    if (hit || markCount>=3) {
      const headerText = hit ? hit.fullHeader : `(åˆ—${c+1})`;
      const pnName     = hit ? hit.pn       : `(UNKNOWN_C${c+1})`;
      pnCols.push({ colIdx:c, header:headerText, pn:pnName });
    }
  }

  const unknownCount = pnCols.filter(x=>String(x.pn).startsWith('(UNKNOWN_')).length;
  if(unknownCount) log(`æç¤ºï¼šä»æœ‰ ${unknownCount} ä¸ªåˆ—æœªæŠ½å–åˆ° PN æ–‡æœ¬ï¼ˆUNKNOWNï¼‰ã€‚`);

  log(`è¯†åˆ«åˆ° PN åˆ—æ•°: ${pnCols.length}ï¼›ç¤ºä¾‹: ${pnCols.slice(0,10).map(x=>x.pn).join(', ')||'(ç©º)'}`);
  return { wb, ws, headerIdx, idxType, idxName, pnCols, range: realRange };
}

/* ===== è§£æ PORï¼ˆAoA ä¸‹æ ‡ï¼‰ ===== */
function parsePORAoA(wb){
  const ws = wb.Sheets[wb.SheetNames[0]];
  const aoa = XLSX.utils.sheet_to_json(ws,{header:1,blankrows:false,defval:''});
  if(!aoa.length) throw new Error('PORSheet.xls å†…å®¹ä¸ºç©ºã€‚');
  const headers=(aoa[0]||[]).map(h=>String(h||'').trim());
  const rowsAoA=aoa.slice(1);
  const idx=(name)=> headers.findIndex(h=>normalizeHeader(h)===normalizeHeader(name));
  const idxNum=idx('Number'); if(idxNum<0) throw new Error('PORSheet.xls ç¼ºå°‘å…³é”®åˆ— "Number"ã€‚');
  return { headers, rowsAoA, idxNum, idxFront:idx('CAMERA'), idxBack:idx('CAMERA_BACK'), idxBat:idx('BATTERY'),
           idxCPU:idx('CPU'), idxColour:idx('COLOUR'), idxAdapter:idx('ADAPTER'), idxWLAN:idx('WLAN'), idxWWAN:idx('WWAN') };
}

/* ===== è§£æ IALï¼ˆTech å·¥ä½œè¡¨ï¼‰ ===== */
function parseIALTech(wb){
  let techSheetName = wb.SheetNames.find(n=>normalizeHeader(n)==='TECH');
  if(!techSheetName){ throw new Error('åœ¨ IAL ä¸­æœªæ‰¾åˆ° "Tech" å·¥ä½œè¡¨'); }
  const ws = wb.Sheets[techSheetName];
  const aoa = XLSX.utils.sheet_to_json(ws,{header:1,blankrows:false,defval:''});
  if(!aoa.length) throw new Error('IAL.Tech å†…å®¹ä¸ºç©º');

  const getRow = (keyRegexArr) => {
    for(let i=0;i<aoa.length;i++){
      const a = String((aoa[i]||[])[0]||'').trim();
      const A = a.toUpperCase();
      if(keyRegexArr.some(rx=>rx.test(A))) {
        const val = String((aoa[i]||[])[1]||'').trim();
        return { rowIdx:i, key:a, value:val };
      }
    }
    return null;
  };
  const osRow   = getRow([/^OS$/]);
  const dispRow = getRow([/^DISPLAY$/]);
  const dimRow  = getRow([/^DIMENSIONS?$/]);
  const wgtRow  = getRow([/^WEIGHT/i]);

  let dims = null;
  if(dimRow && dimRow.value){
    const nums = (dimRow.value.match(/[\d.]+/g)||[]).map(x=>Number(x)).filter(x=>!Number.isNaN(x));
    if(nums.length>=3){ dims = nums.slice(0,3); }
  }

  let weight_g = null;
  if(wgtRow && wgtRow.value){
    const m = wgtRow.value.match(/(\d+(?:\.\d+)?)\s*g/i);
    if(m){ weight_g = Math.round(Number(m[1])); }
  }

  log(`IAL.Tech è§£æï¼šOS='${osRow?osRow.value:'(æ— )'}'ï¼›Display='${dispRow?dispRow.value:'(æ— )'}'ï¼›Dims=${dims?dims.join('/'):'(æ— )'}ï¼›Weight=${weight_g??'(æ— )'}g`);
  return { osText: osRow?osRow.value:'', displayText: dispRow?dispRow.value:'', dims, weight_g };
}

/* ===== Element: OS å·¥ä½œè¡¨ LONGDESC_OS å…¨è¡¨æ ¼å¼æ ¡éªŒ ===== */
function validateAllOSLongdesc(wb){
  const osSheetName = wb.SheetNames.find(n=>normalizeHeader(n)==='OS');
  if(!osSheetName){ log('æç¤ºï¼šElement ä¸­æœªæ‰¾åˆ° OS å·¥ä½œè¡¨ï¼Œè·³è¿‡ LONGDESC_OS æ ¼å¼æ ¡éªŒ'); return { invalid:[] }; }
  const ws = wb.Sheets[osSheetName];
  const aoa = XLSX.utils.sheet_to_json(ws,{header:1,blankrows:false,defval:''});
  if(!aoa.length){ log('æç¤ºï¼šElement.OS å·¥ä½œè¡¨ä¸ºç©º'); return { invalid:[] }; }
  const headers = (aoa[0]||[]).map(h=>String(h||'').trim());
  const idxLong = headers.findIndex(h=>normalizeHeader(h)==='LONGDESC_OS');
  if(idxLong<0){ log('æç¤ºï¼šElement.OS æœªæ‰¾åˆ° LONGDESC_OS åˆ—'); return { invalid:[] }; }

  const invalid = [];
  for(let i=1;i<aoa.length;i++){
    const v = String((aoa[i]||[])[idxLong]||'').trim();
    const ok = /^Android\s+\d+\s+or\s+later$/i.test(v);
    if(!ok){ invalid.push({row:i+1, value:v}); }
  }
  if(invalid.length){
    log(`OS LONGDESC_OS æ ¼å¼ä¸åˆè§„æ¡æ•°ï¼š${invalid.length}`);
  }else{
    log('OS LONGDESC_OS å…¨éƒ¨åˆè§„');
  }
  return { invalid };
}

/* ===== PP å·¥ä½œè¡¨ï¼šæŒ‰ Element ID å–å‡ ä½•ä¸é‡é‡ ===== */
function getPPMetricsByElementID(wb, elementId){
  const ppSheetName = wb.SheetNames.find(n=>normalizeHeader(n)==='PP');
  if(!ppSheetName){ return null; }
  const ws = wb.Sheets[ppSheetName];
  const aoa = XLSX.utils.sheet_to_json(ws,{header:1,blankrows:false,defval:''});
  if(!aoa.length){ return null; }
  const headers=(aoa[0]||[]).map(h=>String(h||'').trim());
  const idx=(name)=> headers.findIndex(h=>normalizeHeader(h)===normalizeHeader(name));
  const idxId    = idx('ELEMENT ID');
  const idxH     = idx('HEIGHT_MET');
  const idxW     = idx('WIDTH_MET');
  const idxD     = idx('DEPTH_MET');
  const idxWeight= idx('WEIGHT_MET');

  if([idxId,idxH,idxW,idxD,idxWeight].some(x=>x<0)) return null;

  for(let i=1;i<aoa.length;i++){
    const row=aoa[i]||[];
    const idCell = String(row[idxId]||'').trim();
    if(idCell===String(elementId)){
      const h = Number(row[idxH]); const w = Number(row[idxW]); const d = Number(row[idxD]); const kg = Number(row[idxWeight]);
      if([h,w,d,kg].some(x=>Number.isNaN(x))) return null;
      return { height_mm: h, width_mm: w, depth_mm: d, weight_g: Math.round(kg*1000) };
    }
  }
  return null;
}

/* ===== æ„å»ºç»“æœï¼ˆèåˆ IAL åŸºå‡†ä¸æ ¸æŸ¥ï¼‰ ===== */
function buildResultsSheet(elem, por, elementWB, ialTech){
  const { ws, headerIdx, idxType, idxName, pnCols, range } = elem;
  const out=[]; const porMap=new Map();
  por.rowsAoA.forEach(r=>{ const num=String(r[por.idxNum]||'').trim(); if(num) porMap.set(num,r); });

  const cellVal = (r,c)=>{ const addr=XLSX.utils.encode_cell({r,c}); const cell=ws[addr]; return cell ? String(cell.v||'') : ''; };
  const norm = (s)=> normalizeHeader(s);
  function markedRowIndicesForPN(colIdx){ const rs=[]; for(let r=headerIdx+1; r<=range.e.r; r++){ const v=cellVal(r,colIdx); if(isMarked(v)) rs.push(r); } return rs; }
  function byType(rowIdxArr, typeKey){ const T = typeKey.toUpperCase(); return rowIdxArr.filter(r=> norm(cellVal(r, idxType))===T ); }

  // OS LONGDESC_OS å…¨è¡¨æ ¼å¼æ ¡éªŒ
  const osLongCheck = validateAllOSLongdesc(elementWB.wb||elementWB);

  pnCols.forEach(({ colIdx, header, pn })=>{
    const porRow=porMap.get(String(pn));
    const items=[]; const pushItem=(name,baseline,test,ok,msg)=>items.push({ name, baseline, test, isMatch:!!ok, message:msg||'' });

    if(String(pn).startsWith('(UNKNOWN_')) {
      pushItem('PORåŒ¹é…','-','-',false,`PN ${pn} åœ¨ POR è¡¨ä¸­æœªæ‰¾åˆ°ï¼ˆåˆ—å¤´æœªæŠ½å–åˆ° PN æ–‡æœ¬ï¼‰`);
      out.push({ pn, fullName: header, items, passCount:0, failCount:items.length });
      return;
    }
    if(!porRow){
      pushItem('PORåŒ¹é…','-','-',false,`PN ${pn} åœ¨ POR è¡¨ä¸­æœªæ‰¾åˆ°`);
      out.push({ pn, fullName: header, items, passCount:0, failCount:items.length });
      return;
    }

    const mrIdxs = markedRowIndicesForPN(colIdx);
    const typeList=['CAM','BAT','MEM','HD','PRC','IMG','PP','OS','MON','WS','PS'];
    const typeCount=typeList.map(t=>`${t}:${byType(mrIdxs,t).length}`).join(' | ');
    log(`PN ${pn} æ ‡è®°è®¡æ•° -> ${typeCount}`);

    // æ‘„åƒå¤´
    [['å‰ç½®',por.idxFront,'Front Camera'],['åç½®',por.idxBack,'Back Camera']].forEach(([cnLabel,porIdx,keyword])=>{
      const porVal=String(porRow[porIdx]||'').trim(); if(!porVal || porVal.toUpperCase()==='NONE') return;
      const porMP=parseCamMPInt(porVal), porMode=parseCamMode(porVal);
      const camRows=byType(mrIdxs,'CAM'); let found=false, match=true, testStr='(æœªæ‰¾åˆ°)';
      for(const r of camRows){ const name=cellVal(r, idxName); if(name.includes(keyword)){ found=true; testStr=name;
        const eMP=parseCamMPInt(name), eMode=parseCamMode(name);
        if((porMP!=null && eMP!=null && porMP!==eMP)||(porMode!==eMode)) match=false; } }
      if(!found) pushItem(`${cnLabel}æ‘„åƒå¤´`,porVal,testStr,false,`ç¼ºå°‘${cnLabel}æ‘„åƒå¤´æ ‡è®°`); else pushItem(`${cnLabel}æ‘„åƒå¤´`,porVal,testStr,match,match?'å‚æ•°åŒ¹é…':'å‚æ•°ä¸åŒ¹é…');
    });

    // ç”µæ± 
    const porBat=String(porRow[por.idxBat]||''); const porBatNums=porBat.match(/\d+/g)||[]; const batRows=byType(mrIdxs,'BAT');
    if(batRows.length!==1) pushItem('Battery',porBat,`(æ ‡è®°æ•° ${batRows.length})`,false,'ç”µæ± æ•°é‡ä¸æ­£ç¡®ï¼ˆæœŸæœ›1ï¼‰');
    else { const name=cellVal(batRows[0],idxName); const nums=name.match(/\d+/g)||[]; const ok=porBatNums.every(n=>nums.includes(n)); pushItem('Battery',porBat,name,ok,ok?'å‚æ•°åŒ¹é…':'å‚æ•°ä¸åŒ¹é…'); }

    // MEM & HDï¼ˆæ¥è‡ª PN æ–‡æœ¬ï¼‰
    const specM=String(header).match(/(\d+)\s*G\s*\+\s*(\d+)\s*G/i);
    if(specM){
      const memSpecInt=specM[1], hdSpecInt=specM[2];
      const memRows=byType(mrIdxs,'MEM');
      if(!memRows.length) pushItem('Memory',`${memSpecInt}G`,'(æœªæ ‡è®°)',false,'ç¼ºå°‘ MEM æ ‡è®°');
      else { const preferred=memRows.find(r=>intsInText(cellVal(r,idxName)).includes(memSpecInt)) ?? memRows[0];
        const name=cellVal(preferred,idxName); const ok=intsInText(name).includes(memSpecInt);
        pushItem('Memory',`${memSpecInt}G`,name,ok,ok?'å®¹é‡åŒ¹é…':'å®¹é‡ä¸åŒ¹é…'); }
      const hdRows=byType(mrIdxs,'HD');
      if(!hdRows.length) pushItem('Storage',`${hdSpecInt}G`,'(æœªæ ‡è®°)',false,'ç¼ºå°‘ HD æ ‡è®°');
      else { const preferred=hdRows.find(r=>intsInText(cellVal(r,idxName)).includes(hdSpecInt)) ?? hdRows[0];
        const name=cellVal(preferred,idxName); const ok=intsInText(name).includes(hdSpecInt);
        pushItem('Storage',`${hdSpecInt}G`,name,ok,ok?'å®¹é‡åŒ¹é…':'å®¹é‡ä¸åŒ¹é…'); }
    }

    // å¤„ç†å™¨
    const porCPU=String(porRow[por.idxCPU]||''); const porCPUints=porCPU.match(/\d+/g)||[]; const prcRows=byType(mrIdxs,'PRC');
    if(prcRows.length!==1) pushItem('Processor',porCPU,`(æ ‡è®°æ•° ${prcRows.length})`,false,'å¤„ç†å™¨æ•°é‡ä¸æ­£ç¡®ï¼ˆæœŸæœ›1ï¼‰');
    else { const name=cellVal(prcRows[0],idxName); const eInts=name.match(/\d+/g)||[]; const ok=porCPUints.length ? porCPUints.every(n=>eInts.includes(n)) : true; pushItem('Processor',porCPU,name,ok,ok?'å‚æ•°åŒ¹é…':'å‚æ•°ä¸åŒ¹é…'); }

    // IMGï¼ˆé¢œè‰²ï¼‰
    const porColour=String(porRow[por.idxColour]||'').trim();
    const imgRows=byType(mrIdxs,'IMG');
    if(imgRows.length!==1) pushItem('IMG',porColour||'(æœªæä¾›)',`(æ ‡è®°æ•° ${imgRows.length})`,false,'IMG æ•°é‡ä¸æ­£ç¡®ï¼ˆæœŸæœ›1ï¼‰');
    else { const name=cellVal(imgRows[0],idxName); const ok=porColour ? name.toLowerCase().includes(porColour.toLowerCase()) : true; pushItem('IMG',porColour||'(æœªæä¾›)',name,ok,ok?'é¢œè‰²åŒ¹é…':'é¢œè‰²ä¸åŒ¹é…'); }

    // PPï¼šIAL å°ºå¯¸/é‡é‡ vs Element.PP
    const ppRows=byType(mrIdxs,'PP');
    if(!ppRows.length){
      const baselineText=`${porColour||'(æ— é¢œè‰²)'} | ${ialTech.dims?ialTech.dims.join('Ã—')+'mm':'(æ— å°ºå¯¸)'} | ${ialTech.weight_g!=null?ialTech.weight_g+'g':'(æ— é‡é‡)'}`;
      pushItem('PPï¼ˆå°ºå¯¸/é‡é‡ï¼‰', baselineText, '(æœªæ ‡è®°)', false, 'ç¼ºå°‘ PP æ ‡è®°');
    }else{
      const idCell = cellVal(ppRows[0], 0);
      const mId = idCell.match(/\[(\d+)\]/);
      const ppId = mId ? mId[1] : null;
      const ppMetrics = ppId ? getPPMetricsByElementID(elementWB.wb||elementWB, ppId) : null;

      const baselineText=`${porColour||'(æ— é¢œè‰²)'} | ${ialTech.dims?ialTech.dims.join('Ã—')+'mm':'(æ— å°ºå¯¸)'} | ${ialTech.weight_g!=null?ialTech.weight_g+'g':'(æ— é‡é‡)'}`;
      if(!ppMetrics || !ialTech.dims || ialTech.weight_g==null){
        const name = cellVal(ppRows[0], idxName);
        pushItem('PPï¼ˆå°ºå¯¸/é‡é‡ï¼‰', baselineText, name || '(æœªæŸ¥åˆ° PP å·¥ä½œè¡¨å‚æ•°)', false, 'PP å‚æ•°ä¸è¶³ï¼Œæ— æ³•æ¯”å¯¹ï¼ˆIAL æˆ– Element.PP ç¼ºå¤±ï¼‰');
      }else{
        const sorted = [...ialTech.dims].map(Number).sort((a,b)=>b-a);
        const ialH=sorted[0], ialW=sorted[1], ialD=sorted[2];
        const elH=ppMetrics.height_mm, elW=ppMetrics.width_mm, elD=ppMetrics.depth_mm, elG=ppMetrics.weight_g;

        function eq(a,b){ return Math.round(a*100)/100 === Math.round(b*100)/100; }
        let okH=eq(ialH,elH), okW=eq(ialW,elW), okD=eq(ialD,elD), okG=(ialTech.weight_g===elG);
        const testText = `H:${elH}mm / W:${elW}mm / D:${elD}mm / Weight:${elG}g`;
        const ok = okH && okW && okD && okG;
        let msg='';
        if(!ok){
          const errs=[];
          if(!okH) errs.push(`é«˜åº¦ä¸åŒ¹é…ï¼ˆIAL ${ialH}mm â‰  EL ${elH}mmï¼‰`);
          if(!okW) errs.push(`å®½åº¦ä¸åŒ¹é…ï¼ˆIAL ${ialW}mm â‰  EL ${elW}mmï¼‰`);
          if(!okD) errs.push(`åšåº¦ä¸åŒ¹é…ï¼ˆIAL ${ialD}mm â‰  EL ${elD}mmï¼‰`);
          if(!okG) errs.push(`é‡é‡ä¸åŒ¹é…ï¼ˆIAL ${ialTech.weight_g}g â‰  EL ${elG}gï¼‰`);
          msg = errs.join('ï¼›');
        }else{
          msg='å°ºå¯¸ä¸é‡é‡åŒ¹é…';
        }
        pushItem('PPï¼ˆå°ºå¯¸/é‡é‡ï¼‰', baselineText, testText, ok, msg);
      }
    }

    // OSï¼šIAL ä¸ºåŸºå‡† + Element.OS LONGDESC_OS æ ¼å¼æ ¸æŸ¥
    const osRows=byType(mrIdxs,'OS');
    const osBaseline = ialTech.osText || '(IAL æœªæä¾›)';
    if(!osRows.length){
      pushItem('OS', osBaseline, '(æœªæ ‡è®°)', false, 'ç¼ºå°‘ OS æ ‡è®°');
    }else{
      const name = cellVal(osRows[0], idxName);
      const invalidCnt = osLongCheck.invalid.length;
      const ok = invalidCnt===0;
      const msg = ok ? 'LONGDESC_OS å…¨éƒ¨åˆè§„' : `OS å·¥ä½œè¡¨ LONGDESC_OS æ ¼å¼é”™è¯¯ ${invalidCnt} æ¡`;
      pushItem('OS', osBaseline, name || '(æœªå–åˆ°å…ƒç´ å)', ok, msg);
    }

    // MONï¼šåªå±•ç¤º IAL.Display ä¸ºåŸºå‡†ï¼Œä½†æ ¸æŸ¥æ•°é‡ï¼ˆæœŸæœ› 1ï¼‰
    const monRows = byType(mrIdxs, 'MON');
    const monBaseline = ialTech.displayText || '(IAL æœªæä¾›)';
    if (monRows.length !== 1) {
      pushItem('MON', monBaseline, `(æ ‡è®°æ•° ${monRows.length})`, false, 'MON æ•°é‡ä¸æ­£ç¡®ï¼ˆæœŸæœ›1ï¼‰');
    } else {
      const monName = cellVal(monRows[0], idxName);
      pushItem('MON', monBaseline, monName || '(æœªå–åˆ°å…ƒç´ å)', true, 'æ•°é‡æ­£ç¡®ï¼ˆå‚æ•°ä¸æ ¸æŸ¥ï¼‰');
    }

    // WS / WLAN / BT / WWAN
    const porWLAN=String(porRow[por.idxWLAN]||''); const wsRows=byType(mrIdxs,'WS'); const wsNames=wsRows.map(r=>cellVal(r,idxName));
    const wlanPart=porWLAN.includes('+')? porWLAN.split('+')[0] : porWLAN;
    if(wlanPart && wlanPart.toLowerCase()!=='nan'){ const ok=wsNames.some(n=>n.toLowerCase().includes(wlanPart.toLowerCase())); const testStr=wsNames.join(' / ')||'(æœªæ ‡è®°)'; pushItem('WLAN',wlanPart,testStr,ok,ok?'åŒ¹é…':'æœªåœ¨æ ‡è®°å…ƒç´ ä¸­æ‰¾åˆ°'); }
    if(porWLAN.includes('+')){ const btPart=porWLAN.split('+')[1]; let m=btPart.match(/BT\s*([0-9]+(?:\.[0-9]+)?)/i)||btPart.match(/Bluetooth[^0-9]*([0-9]+(?:\.[0-9]+)?)/i);
      if(m){ const ver=m[1]; const ok=wsNames.some(n=> new RegExp('Bluetooth[^0-9]*'+escapeReg(ver),'i').test(n)); const testStr=wsNames.join(' / ')||'(æœªæ ‡è®°)'; pushItem('Bluetooth','BT '+ver,testStr,ok,ok?'åŒ¹é…':'ç‰ˆæœ¬ä¸åŒ¹é…'); }
    }
    const porWWAN=String(porRow[por.idxWWAN]||''); const wwanStatus=normalizeWWANValue(porWWAN); const hasWWANMarked=wsNames.some(n=>/(WWAN|LTE|5G|4G|NR)/i.test(n));
    let wwanOk=true, wwanMsg='åŒ¹é…'; if(wwanStatus==='SOME' && !hasWWANMarked){ wwanOk=false; wwanMsg='ç¼ºå°‘ WWAN æ ‡è®°'; } else if(wwanStatus==='NONE' && hasWWANMarked){ wwanOk=false; wwanMsg='POR ä¸º Noneï¼Œä½†æ ‡è®°äº† WWAN'; }
    pushItem('WWAN', porWWAN||'(æœªæä¾›)', hasWWANMarked?'æœ‰ WWAN æ ‡è®°':'æ—  WWAN æ ‡è®°', wwanOk, wwanMsg);

    const passCount=items.filter(i=>i.isMatch).length, failCount=items.length-passCount;
    out.push({ pn, fullName: header, items, passCount, failCount });
  });

  return out;
}

/* ===== æ¸²æŸ“ï¼ˆå¤±è´¥ä¼˜å…ˆ + æŠ˜å  + 100% æ¨ªå¹… + â€œåªçœ‹é”™è¯¯=ä»…å¤±è´¥PNä¸å¤±è´¥é¡¹â€ï¼‰ ===== */
function renderCards(allResults){
  const resultsDiv = document.getElementById('results');
  const checkResultsDiv = document.getElementById('checkResults');
  const summaryDiv = document.getElementById('summary');
  const toggleErrorBtn = document.getElementById('toggleErrorBtn');

  checkResultsDiv.innerHTML = '';

  let totalsAllPassItems = 0, totalsAllFailItems = 0;
  let totalPNs = allResults.length;
  let withFails = 0;

  allResults.forEach(r=>{
    totalsAllPassItems += r.passCount;
    totalsAllFailItems += r.failCount;
    if (r.failCount > 0) withFails++;
  });

  const allPass = withFails === 0;

  let showOnlyErrors = false;
  toggleErrorBtn.disabled = false;
  toggleErrorBtn.textContent = 'åªçœ‹é”™è¯¯';
  toggleErrorBtn.onclick = () => {
    showOnlyErrors = !showOnlyErrors;
    toggleErrorBtn.textContent = showOnlyErrors ? 'æ˜¾ç¤ºå…¨éƒ¨' : 'åªçœ‹é”™è¯¯';
    log(`è§†å›¾åˆ‡æ¢ï¼šåªçœ‹é”™è¯¯ = ${showOnlyErrors ? 'å¼€å¯' : 'å…³é—­'}`);
    renderCore();
  };

  if (allPass) {
    const banner = document.createElement('div');
    banner.className = 'top-banner';
    banner.innerHTML = 'âœ… æœ¬æ¬¡æ£€éªŒå…¨éƒ¨é€šè¿‡ï¼ˆæ­£ç¡®ç‡ <b>100%</b>ï¼‰';
    checkResultsDiv.appendChild(banner);
  }

  const sorted = [
    ...allResults.filter(r => r.failCount > 0),
    ...allResults.filter(r => r.failCount === 0)
  ];

  function renderCore(){
    Array.from(checkResultsDiv.querySelectorAll('.pn-card, .total-info, .empty-hint')).forEach(el=>el.remove());

    const totalInfoDiv = document.createElement('div');
    totalInfoDiv.className = 'total-info';
    totalInfoDiv.style.cssText = `
      background: rgba(227,242,253,.8);
      border: 2px solid #2196f3;
      border-radius: 12px;
      padding: 10px;
      margin-bottom: 14px;
      font-size: 14px;
      font-weight: 600;
      text-align: center;
      max-width: 980px;
      margin-left: auto;
      margin-right: auto;
    `;
    totalInfoDiv.innerHTML = `å…±æ£€éªŒ <span style="color:#2196f3;font-size:18px;">${totalPNs}</span> ä¸ª PN`;
    checkResultsDiv.appendChild(totalInfoDiv);

    let renderedAny = false;

    sorted.forEach((res, idx) => {
      if (showOnlyErrors && res.failCount === 0) return;

      const itemsToRender = showOnlyErrors ? res.items.filter(i => !i.isMatch) : res.items;
      if (showOnlyErrors && itemsToRender.length === 0) return;

      renderedAny = true;

      const detailsEl = document.createElement('details');
      detailsEl.className = 'pn-card';
      detailsEl.open = res.failCount > 0;

      const summaryEl = document.createElement('summary');

      const passRate = res.items.length ? ((res.passCount / res.items.length) * 100).toFixed(1) : '0.0';
      const badge = document.createElement('span');
      badge.className = 'badge ' + (res.failCount === 0 ? 'badge-pass' : 'badge-fail');
      badge.textContent = showOnlyErrors ? `å¤±è´¥é¡¹ ${res.failCount}` : `é€šè¿‡ç‡ ${passRate}%`;

      const heading = document.createElement('div');
      heading.className = 'pn-heading';
      heading.innerHTML = `
        <div class="pn-id">PN ${idx + 1}: ${escapeHTML(res.pn)}</div>
        <div class="pn-full">${escapeHTML(res.fullName)}</div>
      `;

      summaryEl.appendChild(heading);
      summaryEl.appendChild(badge);
      detailsEl.appendChild(summaryEl);

      const bodyEl = document.createElement('div');
      bodyEl.className = 'pn-body';

      itemsToRender.forEach(it => {
        const isPass = it.isMatch;
        const itemDiv = document.createElement('div');
        itemDiv.className = 'check-item';
        itemDiv.innerHTML = `
          <div class="item-name">${escapeHTML(it.name)}</div>
          <div class="item-values">
            åŸºå‡†ï¼š<b>${escapeHTML(it.baseline || '(ç©º)')}</b><br>
            æµ‹è¯•ï¼š<b>${escapeHTML(it.test || '(ç©º)')}</b>
            ${it.message ? `<br><small style="color:${isPass ? '#28a745' : '#dc3545'};">${isPass ? 'âœ“' : 'âœ—'} ${escapeHTML(it.message)}</small>` : ''}
          </div>
          <div class="status ${isPass ? 'pass' : 'fail'}">${isPass ? 'PASS' : 'FAIL'}</div>
        `;
        bodyEl.appendChild(itemDiv);
      });

      detailsEl.appendChild(bodyEl);
      checkResultsDiv.appendChild(detailsEl);
    });

    if (showOnlyErrors && !renderedAny) {
      const emptyHint = document.createElement('div');
      emptyHint.className = 'empty-hint';
      emptyHint.style.cssText = `
        max-width: 980px;
        margin: 8px auto 16px;
        padding: 12px 14px;
        border-radius: 10px;
        border: 1px dashed #22c55e;
        background: rgba(34,197,94,.08);
        color: #14532d;
        text-align: center;
        font-weight: 600;
      `;
      emptyHint.textContent = 'ğŸ‰ å½“å‰ç­›é€‰æ— é”™è¯¯é¡¹ï¼ˆå…¨éƒ¨é€šè¿‡ï¼‰';
      checkResultsDiv.appendChild(emptyHint);
    }

    const totalCount = totalsAllPassItems + totalsAllFailItems;
    const totalPassRate = totalCount ? ((totalsAllPassItems / totalCount) * 100).toFixed(1) : '0.0';
    const successfulPNs = allResults.filter(r => r.failCount === 0).length;
    const partialPNs    = allResults.filter(r => r.failCount > 0).length;

    summaryDiv.innerHTML = `
      <div style="display:flex;justify-content:center;gap:40px;flex-wrap:wrap;">
        <div><div class="stat-number">${totalPNs}</div><div class="stat-label">æ€» PN æ•°</div></div>
        <div><div class="stat-number pass">${successfulPNs}</div><div class="stat-label">å®Œå…¨é€šè¿‡</div></div>
        <div><div class="stat-number fail">${partialPNs}</div><div class="stat-label">éƒ¨åˆ†é€šè¿‡</div></div>
        <div><div class="stat-number pass">${totalsAllPassItems}</div><div class="stat-label">æ€»é€šè¿‡é¡¹</div></div>
        <div><div class="stat-number fail">${totalsAllFailItems}</div><div class="stat-label">æ€»å¤±è´¥é¡¹</div></div>
        <div><div class="stat-number">${totalPassRate}%</div><div class="stat-label">æ€»é€šè¿‡ç‡</div></div>
      </div>`;
    resultsDiv.style.display = 'block';
  }

  renderCore();
}

/* ===== æ‰§è¡ŒæŒ‰é’® ===== */
document.getElementById('runBtn').addEventListener('click', async ()=>{
  log('ç‚¹å‡»â€œå¼€å§‹é…ç½®æ£€éªŒâ€ã€‚æ ¡éªŒå‰ç½®æ¡ä»¶â€¦');
  if(!(window.__XLSX_READY__ && window.XLSX && XLSX.read)){ alert('è§£æåº“æœªåŠ è½½ï¼šè¯·ç¨å€™æˆ–æ£€æŸ¥ç½‘ç»œè®¿é—® CDNã€‚'); log('å‰ç½®æ¡ä»¶å¤±è´¥ï¼šè§£æåº“æœªåŠ è½½'); return; }
  if(!(elementWB && porWB && ialWB)){ alert('è¯·å…ˆé€‰æ‹© Element.xlsx / PORSheet.xls / IAL.xlsx'); log('å‰ç½®æ¡ä»¶å¤±è´¥ï¼šæœªé€‰æ‹©æ–‡ä»¶'); return; }
  const btn=document.getElementById('runBtn'); btn.disabled=true;
  try{
    log('è§£æ Element.xlsxï¼ˆæŒ‰å•å…ƒæ ¼åœ°å€ + ZA10 + æ‰©çª—ï¼‰â€¦'); const elemSheet=parseElementSheet(elementWB);
    log(`Element è§£æå®Œæˆï¼šheaderIdx=${elemSheet.headerIdx}ï¼Œè¯†åˆ« PN=${elemSheet.pnCols.length}`);
    log('è§£æ PORSheet.xlsï¼ˆAoA ä¸‹æ ‡ç‰ˆï¼‰â€¦'); const porAoA=parsePORAoA(porWB);
    log(`POR è§£æå®Œæˆï¼šæ•°æ®è¡Œ=${porAoA.rowsAoA.length}ï¼Œè¡¨å¤´åˆ—=${porAoA.headers.length}`);
    log('è§£æ IAL.Tech â€¦'); const ialTech=parseIALTech(ialWB);
    log('æ‰§è¡Œè¯¦ç»†æ ¡éªŒ â€¦'); const results=buildResultsSheet(elemSheet, porAoA, elemSheet, ialTech);
    log(`æ ¡éªŒå®Œæˆï¼šPN æ•°=${results.length}`);
    log('æ¸²æŸ“ç»“æœ â€¦'); renderCards(results);
    log('å®Œæˆã€‚'); document.querySelector('details.logfold').open=false;
  }catch(err){ alert('æ‰§è¡Œå¤±è´¥ï¼š'+err.message); log('æ‰§è¡Œå¤±è´¥ï¼š'+err.message); console.error(err); }
  finally{ btn.disabled=false; }
});
</script>
</body>
</html>